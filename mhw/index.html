<!DOCTYPE html>
<html>
<head>
<title>MHW</title>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.css">
</head>
<body ng-app="MHWApp" ng-controller="MHWController" ng-cloak>
    <md-content class="md-padding autocomplete" layout="column">
    토벌 몬스터
    <md-chips ng-model="selMonsters" md-autocomplete-snap md-require-match="true" md-on-add="selMonstersAdded()" md-on-remove="selMonstersChanged()">
        <md-autocomplete md-selected-item="selectedMonster" md-search-text="searchText"
            md-items="item in searchMonster(searchText)" md-item-text="item.name">
            {{item.name}}
        </md-autocomplete>
        <md-chip-template>
            {{$chip.name}}
        </md-chip-template>
    </md-chips>

    <md-list class="fixedRows" style="height: 20vh; overflow: auto">
        <md-subheader>몬스터</md-subheader>
        <md-list-item ng-repeat="(index, monster) in monsters" ng-if="selMonsters.indexOf(monster.name) < 0">
            <div class="md-list-item-text compact">
                <h3>{{monster.name}}</h3>
            </div>
        </md-list-item>
    </md-list>

    <div layout="row">
        <table flex>
                <thead style="font-weight: bold">
                    <td>몬스터</td>
                    <td ng-repeat="key in keys">{{key}}</td>
                </thead>
                <tbody>
                    <tr ng-repeat="(index, monster) in selMonsters track by $index">
                        <td>{{monster.name}}</td>
                        <td ng-repeat="(windex, weak) in monster.weakness track by $index">{{weak}}</td>
                    </tr>
                </tbody>
            </table>
    </div>
</md-content>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-animate.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-aria.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-messages.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.8/angular-material.min.js"></script>

<script>
angular.module('MHWApp', ['ngMaterial', 'ngMessages'])
.controller('MHWController', MHWController)

function MHWController($scope, $http) {
    $scope.keys = /*난이도그룹,이름,*/ '불,물,번개,얼음,용,독,수면,마비,폭파,기절' .split(',')
    var rawdata = [
        '3,도스쟈그라스,3,0,2,2,1,3,3,3,3,3',
        '3,쿠루루야크,2,3,2,2,2,2,2,2,2,2',
        '3,푸케푸케,2,0,3,2,1,1,3,3,2,2',
        '3,볼보로스,3,0,0,2,1,3,2,3,3,1',
        '3,쥬라토도스,1,0,3,1,1,2,1,2,1,3',
        '5,토비카가치,2,3,0,2,1,3,2,2,2,2',
        '5,안쟈나프,0,3,2,2,1,2,2,2,1,2',
        '7,리오레이아,0,1,2,1,3,1,2,2,1,3',
        '5,치치야크,2,2,3,3,2,2,2,2,2,2',
        '7,파오우르무,3,0,2,1,1,2,2,2,3,3',
        '7,도스기르오스,2,3,0,2,1,2,3,1,2,2',
        '7,라도발킨,1,1,1,2,3,2,1,2,3,2',
        '8,레이기에나,2,1,3,0,1,3,2,2,2,2',
        '7,오도가론,1,1,2,3,0,1,2,3,2,2',
        '8,리오레우스,0,1,2,1,3,1,2,2,1,2',
        '8,디아블로스,0,2,1,3,2,2,2,3,2,1',
        '9,키린,3,2,0,2,1,1,2,0,2,1',
        '7,도도가마루,0,2,3,2,1,3,2,2,1,2',
        '8,레오레이아 아종,0,1,2,1,3,1,2,2,1,3',
        '8,바젤기우스,0,1,3,2,2,2,2,2,1,1',
        '8,이블조,2,2,3,1,3,2,2,2,2,2',
        '7,볼가노스,0,3,2,2,1,3,1,2,1,2',
        '7,우라간킨,0,3,1,2,2,3,1,2,2,3',
        '8,리오레우스 아종,0,1,1,2,3,1,2,2,1,2',
        '8,디아블로스 아종,0,2,1,3,0,2,2,3,2,1',
        '9,네르기간테,1,1,3,1,2,2,2,2,2,2',
        '9,테오-테스카토르,0,3,1,3,1,2,1,1,1,2',
        '9,크샬다오라,1,0,3,0,2,3,1,1,3,2',
        '9,발하자크,3,0,1,2,3,1,1,1,2,2',
        '9,조라-마그다라오스,0,3,1,2,3,0,0,0,0,0',
        '9,제노-지바,2,2,2,2,2,3,0,1,2,1',
    ]

    $scope.monsters = []
    rawdata.forEach(function(data) {
        var weakness = data.split(',')
        $scope.monsters.push({
            diff: weakness[0],
            name: weakness[1],
            weakness: weakness.slice(2),
        })
    })

    $scope.searchText = ''
    $scope.selectedMonster = null
    $scope.selMonsters = []

    $scope.searchMonster = function(name) {
        return name ? $scope.monsters.filter(function(mon) {
            return mon.name.indexOf(name) != -1
        }) : []
    }

    $scope.selMonstersAdded = function() {
        $scope.searchText = ''
        $scope.selMonstersChanged()
    }

    $scope.selMonstersChanged = function() {
        var scores = []
        for (var i = 0; i < $scope.keys.length; i++) scores.push(0)

        var oldOrder = []
        var newOrder = []
        $scope.selMonsters.forEach(function(monster) {
            oldOrder.push(monster.weakness)
            newOrder.push([])
            for (var i = 0; i < scores.length; i++) {
                scores[i] += monster.diff * monster.diff * (monster.weakness[i] - 1.5)
            }
        })

        var newKeys = []
        while (scores.length > 0) {
            var max = Math.max.apply(null, scores)
            var index = scores.indexOf(max)
            newKeys.push($scope.keys.splice(index, 1)[0])

            scores.splice(index, 1)
            for (var i = 0; i < $scope.selMonsters.length; i++) {
                newOrder[i].push(oldOrder[i].splice(index, 1)[0])
            }
        }
        $scope.keys = newKeys
        $scope.selMonsters.forEach(function(monster) {
            monster.weakness = newOrder.shift()
        })
    }
}

</script>
</body>
</html>
